---
- name: Verify created files and directories attributes
  block:
    - name: Stat created files and directories
      ansible.builtin.stat:
        path: "{{ file.path }}"
      register: fs_file_stat
      loop: "{{ fs_files }}"
      loop_control:
        loop_var: file

    - name: Assert files and directories exist with correct attributes
      ansible.builtin.assert:
        that:
          - fs_file_stat.results[item].stat.exists
          - fs_file_stat.results[item].stat.pw_name == (fs_files[item].owner | default(ansible_user_id))
          - fs_file_stat.results[item].stat.gr_name == (fs_files[item].group | default('root'))
          - fs_file_stat.results[item].stat.mode | string == fs_files[item].mode
        fail_msg: "File or directory {{ fs_files[item].path }} does not have the expected attributes"
      loop: "{{ range(0, fs_files | length) | list }}"
      loop_control:
        loop_var: item
